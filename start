#!/bin/bash
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"
orange="\e[38;5;130m"
blue="\e[38;5;39m"
yellow="\e[38;5;226m"
purple="\e[38;5;141m"
bold_white="\e[1;37m"
reset="\e[0m"
pink="\e[38;5;205m"

hapus_bot_lama() {
    echo -e "${orange}Menghapus bot lama...${neutral}"
    systemctl stop sellvpn.service 2>/dev/null
    systemctl disable sellvpn.service 2>/dev/null
    rm -f /etc/systemd/system/sellvpn.service
    rm -f /usr/bin/sellvpn /usr/bin/server_sellvpn /etc/cron.d/server_sellvpn
    rm -rf /root/BotVPN2
    rm -rf /root/BotVPN22

    # Hapus dari pm2 jika ada
    if command -v pm2 &> /dev/null; then
        pm2 delete sellvpn &> /dev/null
        pm2 save &> /dev/null
    fi

    systemctl daemon-reload
    echo -e "${green}Bot lama berhasil dihapus.${neutral}"
}

setup_bot() {
    timedatectl set-timezone Asia/Jakarta || echo -e "${red}Gagal mengatur zona waktu${neutral}"
    
    if ! dpkg -s nodejs >/dev/null 2>&1; then
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        apt-get install -y nodejs
        npm install -g npm@latest
    fi

    git clone https://github.com/vermiliion/BotVPN22.git /root/BotVPN2 || echo -e "${red}Gagal clone repo${neutral}"
    npm install --prefix /root/BotVPN2 sqlite3 express crypto telegraf axios dotenv

    chmod +x /root/BotVPN2/*
}

server_app() {
    clear
    echo -e "${orange}─────────────────────────────────────────${neutral}"
    echo -e "${green}BOT SELLVPN TELEGRAM${neutral}"
    echo -e "${orange}─────────────────────────────────────────${neutral}"
    read -p "Masukkan token bot: " token
    while [ -z "$token" ]; do
        echo -e "${red}Token bot tidak boleh kosong.${neutral}"
        read -p "Masukkan token bot: " token
    done

    read -p "Masukkan admin ID: " adminid
    while [ -z "$adminid" ]; do
        echo -e "${red}Admin ID tidak boleh kosong.${neutral}"
        read -p "Masukkan admin ID: " adminid
    done

    read -p "Masukkan nama store: " namastore
    while [ -z "$namastore" ]; do
        echo -e "${red}Nama store tidak boleh kosong.${neutral}"
        read -p "Masukkan nama store: " namastore
    done

    read -p "Masukkan DATA QRIS: " dataqris
    while [ -z "$dataqris" ]; do
        echo -e "${red}DATA QRIS tidak boleh kosong.${neutral}"
        read -p "Masukkan DATA QRIS: " dataqris
    done

    read -p "Masukkan MERCHANT ID: " merchantid
    while [ -z "$merchantid" ]; do
        echo -e "${red}MERCHANT ID tidak boleh kosong.${neutral}"
        read -p "Masukkan MERCHANT ID: " merchantid
    done

    read -p "Masukkan API KEY: " apikey
    while [ -z "$apikey" ]; do
        echo -e "${red}API KEY tidak boleh kosong.${neutral}"
        read -p "Masukkan API KEY: " apikey
    done

    echo "{
  \"BOT_TOKEN\": \"$token\",
  \"USER_ID\": \"$adminid\",
  \"NAMA_STORE\": \"$namastore\",
  \"PORT\": \"50123\",
  \"DATA_QRIS\": \"$dataqris\",
  \"MERCHANT_ID\": \"$merchantid\",
  \"API_KEY\": \"$apikey\"
}" >/root/BotVPN2/.vars.json

    # Buat systemd service
    cat >/etc/systemd/system/sellvpn.service <<EOF
[Unit]
Description=App Bot sellvpn Service
After=network.target

[Service]
ExecStart=/usr/bin/sellvpn
Restart=always
User=root
Environment=PATH=/usr/bin:/usr/local/bin
Environment=NODE_ENV=production
WorkingDirectory=/root/BotVPN2

[Install]
WantedBy=multi-user.target
EOF

    # Buat skrip eksekusi
    cat >/usr/bin/sellvpn <<EOF
#!/bin/bash
cd /root/BotVPN2
node app.js
EOF

    # Buat skrip backup via telegram
    cat >/usr/bin/server_sellvpn <<EOF
#!/bin/bash
USER_ID=$adminid
BOT_TOKEN=$token
curl -s -F chat_id="\$USER_ID" -F document=@"/root/BotVPN2/sellvpn.db" "https://api.telegram.org/bot\$BOT_TOKEN/sendDocument" >/dev/null 2>&1
EOF

    # Cron untuk backup
    cat >/etc/cron.d/server_sellvpn <<EOF
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
0 */6 * * * root /usr/bin/server_sellvpn
EOF

    chmod +x /usr/bin/sellvpn /usr/bin/server_sellvpn
    systemctl daemon-reload
    systemctl start sellvpn.service
    systemctl enable sellvpn.service
    systemctl restart sellvpn.service
    systemctl restart apisellvpn
    service cron restart

    echo -e "${orange}─────────────────────────────────────────${neutral}"
    echo -e "${green}Bot berhasil diinstal dan berjalan.${neutral}"
    echo -e "${green}Gunakan perintah ${bold_white}/start${neutral} atau ${bold_white}menu${neutral} di Telegram bot Anda."
}

# Jalankan semua fungsi
if [[ ${1} == "sellvpn" ]]; then
    hapus_bot_lama
    setup_bot
    server_app
else
    echo -e "${red}Perintah tidak valid. Gunakan: ${yellow}start sellvpn${neutral}"
    exit 1
fi
